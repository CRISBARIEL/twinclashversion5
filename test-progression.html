<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Test de ProgresiÃ³n</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1a1a1a;
      color: #0f0;
    }
    button {
      background: #0a0;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      font-size: 16px;
    }
    button:hover {
      background: #0f0;
      color: #000;
    }
    .log {
      background: #000;
      border: 1px solid #0f0;
      padding: 15px;
      margin: 20px 0;
      max-height: 500px;
      overflow-y: auto;
    }
    .error { color: #f00; }
    .success { color: #0f0; }
    .info { color: #0ff; }
  </style>
</head>
<body>
  <h1>ğŸ§ª Test de ProgresiÃ³n de Niveles</h1>

  <div>
    <button onclick="resetWorld()">ğŸ”„ Reset World 1</button>
    <button onclick="testLevel1()">âœ… Completar Nivel 1</button>
    <button onclick="testLevel2()">âœ… Completar Nivel 2</button>
    <button onclick="testLevel3()">âœ… Completar Nivel 3</button>
    <button onclick="checkState()">ğŸ” Ver Estado</button>
    <button onclick="clearLog()">ğŸ—‘ï¸ Limpiar Log</button>
  </div>

  <div class="log" id="log"></div>

  <script type="module">
    import { supabase, getOrCreateClientId } from './src/lib/supabase.js';
    import {
      ensureWorld,
      getWorldState,
      completeWorldLevel,
      getWorldIdForLevel,
      getLevelInWorld
    } from './src/lib/worldProgress.js';

    window.supabase = supabase;
    window.getOrCreateClientId = getOrCreateClientId;
    window.ensureWorld = ensureWorld;
    window.getWorldState = getWorldState;
    window.completeWorldLevel = completeWorldLevel;
    window.getWorldIdForLevel = getWorldIdForLevel;
    window.getLevelInWorld = getLevelInWorld;

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      logDiv.innerHTML += `<div class="${type}">[${time}] ${message}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    window.clearLog = () => {
      document.getElementById('log').innerHTML = '';
    };

    window.resetWorld = async () => {
      try {
        log('ğŸ”„ Reseteando World 1...', 'info');
        const clientId = getOrCreateClientId();

        const { error } = await supabase
          .from('world_progress')
          .delete()
          .eq('client_id', clientId)
          .eq('world_id', 'world-1');

        if (error) throw error;

        localStorage.removeItem('progress.world-1');

        log('âœ… World 1 reseteado correctamente', 'success');

        await ensureWorld('world-1', 5);
        log('âœ… ensureWorld ejecutado', 'success');

        const state = await getWorldState('world-1');
        log('ğŸ“Š Estado inicial:', 'info');
        log(JSON.stringify(state, null, 2), 'info');
      } catch (error) {
        log('âŒ Error: ' + error.message, 'error');
      }
    };

    window.checkState = async () => {
      try {
        log('ğŸ” Consultando estado de World 1...', 'info');
        const state = await getWorldState('world-1');
        log('ğŸ“Š Estado actual:', 'success');
        log(JSON.stringify(state, null, 2), 'info');

        state.levels.forEach((level, idx) => {
          const status = level.completed ? 'âœ… Completado' : level.unlocked ? 'ğŸ”“ Desbloqueado' : 'ğŸ”’ Bloqueado';
          log(`  Nivel ${idx + 1}: ${status} (stars: ${level.stars})`, level.unlocked ? 'success' : 'error');
        });
      } catch (error) {
        log('âŒ Error: ' + error.message, 'error');
      }
    };

    window.testLevel1 = async () => {
      try {
        log('', 'info');
        log('================================', 'info');
        log('ğŸ® COMPLETANDO NIVEL 1', 'info');
        log('================================', 'info');

        const worldId = getWorldIdForLevel(1);
        const levelInWorld = getLevelInWorld(1);

        log(`ğŸ“ Global Level: 1`, 'info');
        log(`ğŸŒ World: ${worldId}`, 'info');
        log(`ğŸ“ Level in World: ${levelInWorld}`, 'info');

        await completeWorldLevel(worldId, levelInWorld, 3);
        log('âœ… completeWorldLevel ejecutado', 'success');

        const state = await getWorldState(worldId);
        log('ğŸ“Š Estado despuÃ©s de completar nivel 1:', 'success');
        log(JSON.stringify(state, null, 2), 'info');

        log('', 'info');
        log('ğŸ” VERIFICACIONES:', 'info');
        log(`  âœ“ Nivel 1 completado: ${state.levels[0].completed ? 'âœ… SÃ' : 'âŒ NO'}`, state.levels[0].completed ? 'success' : 'error');
        log(`  âœ“ Nivel 2 desbloqueado: ${state.levels[1].unlocked ? 'âœ… SÃ' : 'âŒ NO'}`, state.levels[1].unlocked ? 'success' : 'error');

      } catch (error) {
        log('âŒ Error: ' + error.message, 'error');
        console.error(error);
      }
    };

    window.testLevel2 = async () => {
      try {
        log('', 'info');
        log('================================', 'info');
        log('ğŸ® COMPLETANDO NIVEL 2', 'info');
        log('================================', 'info');

        const worldId = getWorldIdForLevel(2);
        const levelInWorld = getLevelInWorld(2);

        log(`ğŸ“ Global Level: 2`, 'info');
        log(`ğŸŒ World: ${worldId}`, 'info');
        log(`ğŸ“ Level in World: ${levelInWorld}`, 'info');

        await completeWorldLevel(worldId, levelInWorld, 3);
        log('âœ… completeWorldLevel ejecutado', 'success');

        const state = await getWorldState(worldId);
        log('ğŸ“Š Estado despuÃ©s de completar nivel 2:', 'success');
        log(JSON.stringify(state, null, 2), 'info');

        log('', 'info');
        log('ğŸ” VERIFICACIONES:', 'info');
        log(`  âœ“ Nivel 2 completado: ${state.levels[1].completed ? 'âœ… SÃ' : 'âŒ NO'}`, state.levels[1].completed ? 'success' : 'error');
        log(`  âœ“ Nivel 3 desbloqueado: ${state.levels[2].unlocked ? 'âœ… SÃ' : 'âŒ NO'}`, state.levels[2].unlocked ? 'success' : 'error');

      } catch (error) {
        log('âŒ Error: ' + error.message, 'error');
        console.error(error);
      }
    };

    window.testLevel3 = async () => {
      try {
        log('', 'info');
        log('================================', 'info');
        log('ğŸ® COMPLETANDO NIVEL 3', 'info');
        log('================================', 'info');

        const worldId = getWorldIdForLevel(3);
        const levelInWorld = getLevelInWorld(3);

        log(`ğŸ“ Global Level: 3`, 'info');
        log(`ğŸŒ World: ${worldId}`, 'info');
        log(`ğŸ“ Level in World: ${levelInWorld}`, 'info');

        await completeWorldLevel(worldId, levelInWorld, 3);
        log('âœ… completeWorldLevel ejecutado', 'success');

        const state = await getWorldState(worldId);
        log('ğŸ“Š Estado despuÃ©s de completar nivel 3:', 'success');
        log(JSON.stringify(state, null, 2), 'info');

        log('', 'info');
        log('ğŸ” VERIFICACIONES:', 'info');
        log(`  âœ“ Nivel 3 completado: ${state.levels[2].completed ? 'âœ… SÃ' : 'âŒ NO'}`, state.levels[2].completed ? 'success' : 'error');
        log(`  âœ“ Nivel 4 desbloqueado: ${state.levels[3].unlocked ? 'âœ… SÃ' : 'âŒ NO'}`, state.levels[3].unlocked ? 'success' : 'error');

      } catch (error) {
        log('âŒ Error: ' + error.message, 'error');
        console.error(error);
      }
    };

    log('âœ… Script de test cargado correctamente', 'success');
    log('ğŸ’¡ Usa los botones de arriba para probar la progresiÃ³n', 'info');
  </script>
</body>
</html>
